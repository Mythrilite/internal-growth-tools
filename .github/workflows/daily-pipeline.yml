name: Daily Lead Generation Pipeline

on:
  # Run at 7:30am ET (12:30 UTC in EST, 11:30 UTC in EDT)
  # Apify runs at 7am, this fetches results 30 minutes later
  schedule:
    - cron: '30 12 * * *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hour timeout for safety

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'scripts/requirements.txt'

      - name: Install Python dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Create data directory
        run: mkdir -p data

      - name: Run pipeline
        env:
          APIFY_API_KEY: ${{ secrets.APIFY_API_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          ICYPEAS_API_KEY: ${{ secrets.ICYPEAS_API_KEY }}
          ICYPEAS_USER_ID: ${{ secrets.ICYPEAS_USER_ID }}
          INSTANTLY_API_KEY: ${{ secrets.INSTANTLY_API_KEY }}
          PROSP_API_KEY: ${{ secrets.PROSP_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            python scripts/pipeline/daily_lead_pipeline.py --test > pipeline_output.log 2>&1
          else
            python scripts/pipeline/daily_lead_pipeline.py > pipeline_output.log 2>&1
          fi
          exit_code=$?
          cat pipeline_output.log
          exit $exit_code

      - name: Post to Discord on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('pipeline_output.log', 'utf8');
            
            // Extract metrics from log
            const metrics = {
              jobs_scraped: log.match(/Jobs scraped: (\d+)/)?.[1] || '0',
              companies_filtered: log.match(/Companies filtered: (\d+)/)?.[1] || '0',
              decision_makers: log.match(/Decision makers found: (\d+)/)?.[1] || '0',
              leads_enriched: log.match(/Leads enriched: (\d+)/)?.[1] || '0',
              leads_validated: log.match(/Leads validated: (\d+)/)?.[1] || '0',
              email_uploaded: log.match(/Email campaign: (\d+) uploaded/)?.[1] || '0',
              linkedin_uploaded: log.match(/LinkedIn campaign: (\d+) uploaded/)?.[1] || '0',
            };
            
            const webhook_url = '${{ secrets.DISCORD_WEBHOOK }}';
            if (!webhook_url) {
              console.log('No Discord webhook configured');
              process.exit(0);
            }

            console.log('Sending Discord notification...');
            console.log('Metrics:', JSON.stringify(metrics, null, 2));

            const https = require('https');
            const url = new URL(webhook_url);
            const payload = JSON.stringify({
              embeds: [{
                title: '✅ Pipeline Complete',
                color: 0x00ff00,
                fields: [
                  { name: 'Jobs Scraped', value: metrics.jobs_scraped, inline: true },
                  { name: 'Companies Filtered', value: metrics.companies_filtered, inline: true },
                  { name: 'Decision Makers', value: metrics.decision_makers, inline: true },
                  { name: 'Leads Enriched', value: metrics.leads_enriched, inline: true },
                  { name: 'Leads Validated', value: metrics.leads_validated, inline: true },
                  { name: 'Email Uploads', value: metrics.email_uploaded, inline: true },
                  { name: 'LinkedIn Uploads', value: metrics.linkedin_uploaded, inline: true },
                ],
                timestamp: new Date().toISOString(),
                footer: { text: `Run #${context.runNumber}` }
              }]
            });

            console.log('Payload size:', payload.length, 'bytes');
            
            return new Promise((resolve, reject) => {
              const options = {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(payload, 'utf8')
                }
              };

              const req = https.request(url, options, (res) => {
                let data = '';
                res.on('data', (chunk) => { data += chunk; });
                res.on('end', () => {
                  console.log(`Discord response status: ${res.statusCode}`);
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    console.log('Discord notification sent successfully');
                    resolve();
                  } else {
                    console.error(`Discord API error: ${res.statusCode}`);
                    console.error(`Response body: ${data}`);
                    reject(new Error(`Discord webhook failed with status ${res.statusCode}: ${data}`));
                  }
                });
              });

              req.on('error', (err) => {
                console.error('Discord webhook request error:', err);
                reject(err);
              });
              req.write(payload);
              req.end();
            });

      - name: Post to Discord on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let error_msg = 'Unknown error';
            try {
              const log = fs.readFileSync('pipeline_output.log', 'utf8');
              const match = log.match(/PIPELINE FAILED: (.+)/);
              if (match) error_msg = match[1];
            } catch(e) {}
            
            const webhook_url = '${{ secrets.DISCORD_WEBHOOK }}';
            if (!webhook_url) {
              console.log('No Discord webhook configured');
              process.exit(0);
            }

            console.log('Sending Discord failure notification...');
            console.log('Error message:', error_msg);

            const https = require('https');
            const url = new URL(webhook_url);
            const payload = JSON.stringify({
              embeds: [{
                title: '❌ Pipeline Failed',
                color: 0xff0000,
                fields: [
                  { name: 'Error', value: error_msg.substring(0, 1024) }
                ],
                timestamp: new Date().toISOString(),
                footer: { text: `Run #${context.runNumber}` }
              }]
            });

            console.log('Payload size:', payload.length, 'bytes');
            
            return new Promise((resolve, reject) => {
              const options = {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(payload, 'utf8')
                }
              };

              const req = https.request(url, options, (res) => {
                let data = '';
                res.on('data', (chunk) => { data += chunk; });
                res.on('end', () => {
                  console.log(`Discord response status: ${res.statusCode}`);
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    console.log('Discord notification sent successfully');
                    resolve();
                  } else {
                    console.error(`Discord API error: ${res.statusCode}`);
                    console.error(`Response body: ${data}`);
                    reject(new Error(`Discord webhook failed with status ${res.statusCode}: ${data}`));
                  }
                });
              });

              req.on('error', (err) => {
                console.error('Discord webhook request error:', err);
                reject(err);
              });
              req.write(payload);
              req.end();
            });

      - name: Upload pipeline database
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-db-${{ github.run_number }}
          path: data/pipeline.db
          retention-days: 30

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-logs-${{ github.run_number }}
          path: logs/
          retention-days: 30
          if-no-files-found: ignore


