name: Enrichment Scale Test

on:
  workflow_dispatch:
    inputs:
      test_size:
        description: 'Number of test leads'
        required: false
        default: '1000'
        type: choice
        options:
          - '100'
          - '500'
          - '1000'

jobs:
  test-enrichment:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'scripts/requirements.txt'

      - name: Install Python dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Run enrichment scale test
        env:
          ICYPEAS_API_KEY: ${{ secrets.ICYPEAS_API_KEY }}
          ICYPEAS_USER_ID: ${{ secrets.ICYPEAS_USER_ID }}
        run: |
          python scripts/pipeline/test_enrichment_scale.py ${{ github.event.inputs.test_size }} 2>&1 | tee enrichment_test_output.log

      - name: Post results to Discord
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let log = '';
            try {
              log = fs.readFileSync('enrichment_test_output.log', 'utf8');
            } catch(e) {
              console.log('Could not read log file');
            }
            
            // Extract results
            const results = {
              test_size: '${{ github.event.inputs.test_size || "1000" }}',
              time_taken: log.match(/Time: ([\d.]+)s/)?.[1] || 'unknown',
              emails_found: log.match(/Emails found: (\d+)\/(\d+)/)?.[1] || 'unknown',
              total_leads: log.match(/Emails found: \d+\/(\d+)/)?.[1] || 'unknown',
              success_rate: log.match(/\(([\d.]+)%\)/)?.[1] || 'unknown',
            };
            
            const webhook_url = '${{ secrets.DISCORD_WEBHOOK }}';
            if (!webhook_url) {
              console.log('No Discord webhook configured');
              process.exit(0);
            }
            
            const https = require('https');
            const url = new URL(webhook_url);
            const payload = JSON.stringify({
              embeds: [{
                title: 'ðŸ“Š Enrichment Scale Test Complete',
                color: 0x0099ff,
                fields: [
                  { name: 'Test Size', value: results.test_size + ' leads', inline: true },
                  { name: 'Time Taken', value: results.time_taken + 's', inline: true },
                  { name: 'Emails Found', value: `${results.emails_found}/${results.total_leads}`, inline: true },
                  { name: 'Success Rate', value: results.success_rate + '%', inline: true },
                ],
                timestamp: new Date().toISOString(),
                footer: { text: `Run #${context.runNumber}` }
              }]
            });
            
            return new Promise((resolve, reject) => {
              const options = {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': payload.length
                }
              };
              
              const req = https.request(url, options, (res) => {
                res.on('data', () => {});
                res.on('end', () => resolve());
              });
              
              req.on('error', reject);
              req.write(payload);
              req.end();
            });

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: enrichment-test-results-${{ github.run_number }}
          path: enrichment_test_output.log
          retention-days: 30
